'use strict';
(function($) {
    if (typeof wc_neokurir_jne_js_params === 'undefined') {
        return false;
    };
    $(document).ready(function() {
		var billing_country  = $('#billing_country');
		var shipping_country = $('#shipping_country');
		var billing_city     = $('#billing_city');
		var shipping_city    = $('#shipping_city');
		var billing_nk_city  = $('#billing_nk_city');
		var shipping_nk_city = $('#shipping_nk_city');

        // hide parent field at the begining
        billing_nk_city.parent().hide();
        shipping_nk_city.parent().hide();

        $('body').on('change', '#billing_state, #shipping_state', function() {
			var fieldID     = $(this).attr('id');
			var fieldCity   = null;
			var fieldNkCity = null;
			var country     = null;
			var province    = $(this).val();
			var data        = {
                action: wc_neokurir_jne_js_params.plugin_id + '_post_cities',
                province: province,
                _wpnonce: wc_neokurir_jne_js_params._wpnonce
            };

            switch (fieldID) {
                case 'billing_state':
					country     = billing_country.val();
					fieldCity   = billing_city;
					fieldNkCity = billing_nk_city;
                    break;
                case 'shipping_state':
					country     = shipping_country.val();
					fieldCity   = shipping_city;
					fieldNkCity = shipping_nk_city;
                    break;
            }

            if (country === 'ID' && province) {
                
                fieldNkCity.prop('disabled', true);
                
                $.post(wc_neokurir_jne_js_params.ajax_url, data, function(response) {
                    
                    fieldCity.val('');
                    fieldCity.parent().hide();

                    var list_cities = '<option value="" selected="selected">Select Town / City</option>';
                    $.each(response, function(v, k) {
                        list_cities += '<option value="' + k.id + '">' + k.name + '</option>';
                    });
                    
                    fieldNkCity.html(list_cities);
                    fieldNkCity.parent().show();
                    fieldNkCity.prop('disabled', false);

                    if ($.isFunction($.fn.select2)) {
                        fieldNkCity.select2({
                            formatNoMatches: function(term) {
                                return 'Data not found';
                            },
                            placeholderOption: 'first'
                        });
                    } else if ($.isFunction($.fn.chosen)) {
                        fieldNkCity.chosen({
                            width: '100%'
                        });
                        fieldCity.trigger('chosen:updated');
                    }
                
                    fieldNkCity.change();
                });
            } else {
            	fieldCity.val('');
            	fieldCity.parent().show();
            	fieldNkCity.parent().hide();
            }
        });

		$('body').on('change', '#billing_nk_city, #shipping_nk_city', function() {
			var fieldID     = $(this).attr('id');
			var fieldCity   = null;
			var fieldNkCity = null;
			var country     = null;

            switch (fieldID) {
                case 'billing_nk_city':
                    country     = billing_country.val();
                    fieldCity   = billing_city;
                    fieldNkCity = billing_nk_city;
                    break;
                case 'shipping_nk_city':
                    country     = shipping_country.val();
                    fieldCity   = shipping_city;
                    fieldNkCity = shipping_nk_city;
                    break;
            }

            if (country === 'ID' && fieldNkCity.val() != '') {
                fieldCity.val(fieldNkCity.find('option:selected').text()).change();
            }
        });
    });
})(jQuery);